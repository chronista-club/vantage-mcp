{% extends "base.tera" %}

{% block title %}Ichimi Server - ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h2>ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†</h2>
        <div class="dashboard-actions">
            <button class="button" id="refreshBtn">
                <span>ğŸ”„ æ›´æ–°</span>
            </button>
            <button class="button" id="addProcessBtn">
                <span>â• æ–°è¦ãƒ—ãƒ­ã‚»ã‚¹</span>
            </button>
        </div>
    </div>
    
    <div class="stats-grid">
        <div class="card stat-card">
            <div class="stat-label">ç¨¼åƒä¸­</div>
            <div class="stat-value" id="runningCount">0</div>
        </div>
        <div class="card stat-card">
            <div class="stat-label">åœæ­¢ä¸­</div>
            <div class="stat-value" id="stoppedCount">0</div>
        </div>
        <div class="card stat-card">
            <div class="stat-label">ã‚¨ãƒ©ãƒ¼</div>
            <div class="stat-value" id="failedCount">0</div>
        </div>
        <div class="card stat-card">
            <div class="stat-label">åˆè¨ˆ</div>
            <div class="stat-value" id="totalCount">0</div>
        </div>
    </div>
    
    <div class="processes-section">
        <h3>ãƒ—ãƒ­ã‚»ã‚¹ä¸€è¦§</h3>
        <div class="process-grid" id="processList">
            <!-- ãƒ—ãƒ­ã‚»ã‚¹ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        </div>
    </div>
    
    <div id="emptyState" class="empty-state" style="display: none;">
        <div class="card">
            <p>ãƒ—ãƒ­ã‚»ã‚¹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            <button class="button" onclick="document.getElementById('addProcessBtn').click()">
                æœ€åˆã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’è¿½åŠ 
            </button>
        </div>
    </div>
</div>

<!-- ãƒ—ãƒ­ã‚»ã‚¹è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="addProcessModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>æ–°è¦ãƒ—ãƒ­ã‚»ã‚¹è¿½åŠ </h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addProcessForm">
                <div class="form-group">
                    <label for="processId">ãƒ—ãƒ­ã‚»ã‚¹ID</label>
                    <input type="text" id="processId" name="id" required placeholder="my-process">
                </div>
                <div class="form-group">
                    <label for="processCommand">ã‚³ãƒãƒ³ãƒ‰</label>
                    <input type="text" id="processCommand" name="command" required placeholder="/usr/bin/node">
                </div>
                <div class="form-group">
                    <label for="processArgs">å¼•æ•°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
                    <input type="text" id="processArgs" name="args" placeholder="server.js, --port, 3000">
                </div>
                <div class="form-group">
                    <label for="processCwd">ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</label>
                    <input type="text" id="processCwd" name="cwd" placeholder="/path/to/project">
                </div>
                <div class="form-actions">
                    <button type="button" class="button button-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="button">è¿½åŠ </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .dashboard-header h2 {
        font-size: 1.75rem;
        font-weight: 600;
    }
    
    .dashboard-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        text-align: center;
        padding: 1rem;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--accent-color);
    }
    
    .processes-section h3 {
        margin-bottom: 1rem;
        font-size: 1.25rem;
    }
    
    .process-card {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .process-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .process-title {
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .process-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }
    
    .process-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .button-small {
        padding: 0.25rem 0.75rem;
        font-size: 0.8rem;
    }
    
    .button-secondary {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }
    
    .button-danger {
        background-color: var(--danger-color);
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
    }
    
    .empty-state p {
        color: var(--text-secondary);
        margin-bottom: 1rem;
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .modal-content {
        background-color: var(--card-bg);
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-secondary);
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .form-group input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: var(--bg-primary);
        color: var(--text-primary);
    }
    
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 1.5rem;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    let processes = [];
    
    // ãƒ—ãƒ­ã‚»ã‚¹ä¸€è¦§ã‚’å–å¾—
    async function fetchProcesses() {
        try {
            const response = await fetch('/api/processes');
            if (response.ok) {
                processes = await response.json();
                updateUI();
            }
        } catch (error) {
            console.error('ãƒ—ãƒ­ã‚»ã‚¹ä¸€è¦§ã®å–å¾—ã«å¤±æ•—:', error);
        }
    }
    
    // UIæ›´æ–°
    function updateUI() {
        const stats = {
            running: 0,
            stopped: 0,
            failed: 0
        };
        
        const processList = document.getElementById('processList');
        processList.innerHTML = '';
        
        if (processes.length === 0) {
            document.getElementById('emptyState').style.display = 'block';
            document.querySelector('.processes-section').style.display = 'none';
        } else {
            document.getElementById('emptyState').style.display = 'none';
            document.querySelector('.processes-section').style.display = 'block';
            
            processes.forEach(process => {
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ã‚¦ãƒ³ãƒˆ
                const processState = process.state?.state || process.state || 'Stopped';
                if (processState === 'Running') stats.running++;
                else if (processState === 'Stopped') stats.stopped++;
                else if (processState === 'Failed') stats.failed++;
                
                // ãƒ—ãƒ­ã‚»ã‚¹ã‚«ãƒ¼ãƒ‰ä½œæˆ
                const card = createProcessCard(process);
                processList.appendChild(card);
            });
        }
        
        // çµ±è¨ˆæ›´æ–°
        document.getElementById('runningCount').textContent = stats.running;
        document.getElementById('stoppedCount').textContent = stats.stopped;
        document.getElementById('failedCount').textContent = stats.failed;
        document.getElementById('totalCount').textContent = processes.length;
    }
    
    // ãƒ—ãƒ­ã‚»ã‚¹ã‚«ãƒ¼ãƒ‰ä½œæˆ
    function createProcessCard(process) {
        const card = document.createElement('div');
        card.className = 'card process-card';
        
        const processState = process.state?.state || process.state || 'Stopped';
        const statusClass = processState.toLowerCase();
        const statusText = processState === 'Running' ? 'ç¨¼åƒä¸­' : 
                          processState === 'Stopped' ? 'åœæ­¢ä¸­' : 'ã‚¨ãƒ©ãƒ¼';
        
        card.innerHTML = `
            <div class="process-header">
                <span class="process-title">${process.id}</span>
                <span class="status-badge status-${statusClass}">${statusText}</span>
            </div>
            <div class="process-info">
                <span>ã‚³ãƒãƒ³ãƒ‰: ${process.command}</span>
                ${process.state?.pid ? `<span>PID: ${process.state.pid}</span>` : ''}
                ${process.args && process.args.length > 0 ? `<span>å¼•æ•°: ${process.args.join(' ')}</span>` : ''}
            </div>
            <div class="process-actions">
                ${processState === 'Stopped' ? 
                    `<button class="button button-small" onclick="startProcess('${process.id}')">é–‹å§‹</button>` :
                    `<button class="button button-small button-danger" onclick="stopProcess('${process.id}')">åœæ­¢</button>`
                }
                <button class="button button-small button-secondary" onclick="viewLogs('${process.id}')">ãƒ­ã‚°</button>
                <button class="button button-small button-secondary" onclick="removeProcess('${process.id}')">å‰Šé™¤</button>
            </div>
        `;
        
        return card;
    }
    
    // ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹
    async function startProcess(id) {
        try {
            const response = await fetch(`/api/processes/${id}/start`, { method: 'POST' });
            if (response.ok) {
                fetchProcesses();
            }
        } catch (error) {
            console.error('ãƒ—ãƒ­ã‚»ã‚¹ã®é–‹å§‹ã«å¤±æ•—:', error);
        }
    }
    
    // ãƒ—ãƒ­ã‚»ã‚¹åœæ­¢
    async function stopProcess(id) {
        try {
            const response = await fetch(`/api/processes/${id}/stop`, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            if (response.ok) {
                fetchProcesses();
            }
        } catch (error) {
            console.error('ãƒ—ãƒ­ã‚»ã‚¹ã®åœæ­¢ã«å¤±æ•—:', error);
        }
    }
    
    // ãƒ—ãƒ­ã‚»ã‚¹å‰Šé™¤
    async function removeProcess(id) {
        if (confirm(`ãƒ—ãƒ­ã‚»ã‚¹ "${id}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            try {
                const response = await fetch(`/api/processes/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    fetchProcesses();
                }
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚»ã‚¹ã®å‰Šé™¤ã«å¤±æ•—:', error);
            }
        }
    }
    
    // ãƒ­ã‚°è¡¨ç¤ºï¼ˆä»Šå¾Œå®Ÿè£…ï¼‰
    function viewLogs(id) {
        alert(`ãƒ—ãƒ­ã‚»ã‚¹ "${id}" ã®ãƒ­ã‚°è¡¨ç¤ºæ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™`);
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    document.getElementById('addProcessBtn').addEventListener('click', () => {
        document.getElementById('addProcessModal').style.display = 'flex';
    });
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
    function closeModal() {
        document.getElementById('addProcessModal').style.display = 'none';
        document.getElementById('addProcessForm').reset();
    }
    
    // ãƒ—ãƒ­ã‚»ã‚¹è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('addProcessForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const args = formData.get('args').split(',').map(a => a.trim()).filter(a => a);
        
        const processData = {
            id: formData.get('id'),
            command: formData.get('command'),
            args: args.length > 0 ? args : undefined,
            cwd: formData.get('cwd') || undefined
        };
        
        try {
            const response = await fetch('/api/processes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(processData)
            });
            
            if (response.ok) {
                closeModal();
                fetchProcesses();
            } else {
                alert('ãƒ—ãƒ­ã‚»ã‚¹ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        } catch (error) {
            console.error('ãƒ—ãƒ­ã‚»ã‚¹ã®è¿½åŠ ã«å¤±æ•—:', error);
            alert('ãƒ—ãƒ­ã‚»ã‚¹ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    });
    
    // æ›´æ–°ãƒœã‚¿ãƒ³
    document.getElementById('refreshBtn').addEventListener('click', fetchProcesses);
    
    // åˆæœŸãƒ­ãƒ¼ãƒ‰
    fetchProcesses();
    
    // å®šæœŸæ›´æ–°ï¼ˆ5ç§’ã”ã¨ï¼‰
    setInterval(fetchProcesses, 5000);
</script>
{% endblock %}